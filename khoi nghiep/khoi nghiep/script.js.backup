// ViLaw - JavaScript Functionality

// Initialize Lucide icons when page loads
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    initializeApp();
});

// App initialization
function initializeApp() {
    setupNavigation();
    setupMobileMenu();
    setupChatFeatures();
    setupDocumentFeatures();
    setupSearchFeatures();
    setupContractFeatures();
    setupVoiceFeatures();
}

// Navigation System
function setupNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.getAttribute('data-page');
            if (pageId) {
                navigateToPage(pageId);
            }
        });
    });
}

function navigateToPage(pageId) {
    // Hide all pages
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // Show target page
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
        
        // Update navigation
        updateNavigation(pageId);
        
        // Scroll to top
        window.scrollTo(0, 0);
        
        // Add fade animation
        targetPage.classList.add('fade-in');
        setTimeout(() => targetPage.classList.remove('fade-in'), 500);
    }
}

function updateNavigation(activePageId) {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === activePageId) {
            link.classList.add('active');
        }
    });
}

// Mobile Menu
function setupMobileMenu() {
    const navToggle = document.getElementById('navToggle');
    const navMenu = document.getElementById('navMenu');
    
    if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
            navMenu.classList.toggle('active');
        });
        
        // Close menu when clicking on a link
        const navLinks = navMenu.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                navMenu.classList.remove('active');
            });
        });
    }
}

// Chat Features
function setupChatFeatures() {
    const messageInput = document.getElementById('messageInput');
    
    if (messageInput) {
        // Enter key to send message
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    
    if (!messageInput || !chatMessages) return;
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input
    messageInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Get AI response
    setTimeout(async () => {
        try {
            const aiResponse = await generateAIResponse(message);
            hideTypingIndicator();
            addMessage(aiResponse, 'ai');
        } catch (error) {
            hideTypingIndicator();
            addMessage('Xin l·ªói, c√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω c√¢u h·ªèi c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.', 'ai');
        }
    }, 500); // Shorter delay for real API
}

function addMessage(text, sender) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    if (sender === 'ai' && text.includes('\n')) {
        // Handle multiline AI responses
        const lines = text.split('\n');
        lines.forEach((line, index) => {
            if (line.trim()) {
                const p = document.createElement('p');
                p.textContent = line;
                content.appendChild(p);
            }
        });
    } else {
        content.innerHTML = `<p>${text}</p>`;
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function generateAIResponse(userMessage) {
    try {
        // Show typing indicator for longer time as we're making real API call
        const response = await apiService.chatWithAI(userMessage, currentLanguage);
        return response.response;
    } catch (error) {
        console.error('AI API error:', error);
        
        // Fallback to local responses if API fails
        const responses = {
            'ly h√¥n': 'V·ªÅ th·ªß t·ª•c ly h√¥n, theo B·ªô lu·∫≠t D√¢n s·ª± 2015, b·∫°n c√≥ th·ªÉ ly h√¥n th√¥ng qua:\n\n1. Ly h√¥n ƒë∆°n ph∆∞∆°ng: N·ªôp ƒë∆°n t·∫°i TAND\n2. Ly h√¥n th·ªèa thu·∫≠n: ƒêƒÉng k√Ω t·∫°i UBND\n\nB·∫°n c·∫ßn chu·∫©n b·ªã c√°c gi·∫•y t·ªù nh∆∞: Gi·∫•y k·∫øt h√¥n, CMND, gi·∫•y khai sinh con (n·∫øu c√≥). T√¥i c√≥ th·ªÉ h·ªó tr·ª£ so·∫°n ƒë∆°n ly h√¥n cho b·∫°n.',
            
            'lao ƒë·ªông': 'V·ªÅ quy·ªÅn l·ª£i ng∆∞·ªùi lao ƒë·ªông theo B·ªô lu·∫≠t Lao ƒë·ªông 2019:\n\n‚Ä¢ ƒê∆∞·ª£c k√Ω h·ª£p ƒë·ªìng lao ƒë·ªông b·∫±ng vƒÉn b·∫£n\n‚Ä¢ ƒê∆∞·ª£c tr·∫£ l∆∞∆°ng ƒë·∫ßy ƒë·ªß, ƒë√∫ng h·∫°n\n‚Ä¢ ƒê∆∞·ª£c ngh·ªâ ph√©p, ngh·ªâ l·ªÖ c√≥ l∆∞∆°ng\n‚Ä¢ ƒê∆∞·ª£c b·∫£o hi·ªÉm x√£ h·ªôi, y t·∫ø\n‚Ä¢ Kh√¥ng b·ªã sa th·∫£i tr√°i lu·∫≠t\n\nB·∫°n c√≥ v·∫•n ƒë·ªÅ c·ª• th·ªÉ n√†o v·ªÅ lao ƒë·ªông kh√¥ng?',
            
            'mua b√°n nh√†': 'Th·ªß t·ª•c mua b√°n nh√† ƒë·∫•t c·∫ßn c√°c b∆∞·ªõc:\n\n1. Ki·ªÉm tra ph√°p l√Ω c·ªßa nh√†/ƒë·∫•t\n2. Th·ªèa thu·∫≠n gi√° c·∫£, k√Ω h·ª£p ƒë·ªìng\n3. N·ªôp thu·∫ø, ph√≠ chuy·ªÉn nh∆∞·ª£ng\n4. L√†m th·ªß t·ª•c sang t√™n t·∫°i S·ªü TN&MT\n\nC·∫ßn gi·∫•y t·ªù: S·ªï ƒë·ªè, CMND, gi·∫•y k·∫øt h√¥n. T√¥i c√≥ th·ªÉ gi√∫p so·∫°n h·ª£p ƒë·ªìng mua b√°n cho b·∫°n.',
            
            'default': 'Xin l·ªói, hi·ªán t·∫°i t√¥i kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi d·ªãch v·ª• AI. ƒê√¢y l√† ph·∫£n h·ªìi t·∫°m th·ªùi. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i sau.'
        };
        
        const lowerMessage = userMessage.toLowerCase();
        
        for (const keyword in responses) {
            if (keyword !== 'default' && lowerMessage.includes(keyword)) {
                return responses[keyword];
            }
        }
        
        return responses.default;
    }
}

function askQuickQuestion(question) {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.value = question;
        sendMessage();
    }
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-message';
    typingDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingMessage = document.querySelector('.typing-message');
    if (typingMessage) {
        typingMessage.remove();
    }
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    // Keep only the initial AI message
    const messages = chatMessages.querySelectorAll('.message');
    for (let i = 1; i < messages.length; i++) {
        messages[i].remove();
    }
}

// Document Features
function setupDocumentFeatures() {
    // Template selection handled by onclick in HTML
}

function selectTemplate(templateType) {
    const templates = {
        'contract': {
            title: 'H·ª£p ƒë·ªìng mua b√°n',
            content: `H·ª¢P ƒê·ªíNG MUA B√ÅN

H√¥m nay, ng√†y [ng√†y] th√°ng [th√°ng] nƒÉm [nƒÉm], t·∫°i [ƒë·ªãa ƒëi·ªÉm], ch√∫ng t√¥i g·ªìm:

B√äN B√ÅN (B√™n A):
- H·ªç v√† t√™n: [H·ªç t√™n ng∆∞·ªùi b√°n]
- CMND/CCCD s·ªë: [S·ªë CMND] c·∫•p ng√†y [ng√†y c·∫•p] t·∫°i [n∆°i c·∫•p]
- ƒê·ªãa ch·ªâ: [ƒê·ªãa ch·ªâ]

B√äN MUA (B√™n B):
- H·ªç v√† t√™n: [H·ªç t√™n ng∆∞·ªùi mua]
- CMND/CCCD s·ªë: [S·ªë CMND] c·∫•p ng√†y [ng√†y c·∫•p] t·∫°i [n∆°i c·∫•p]
- ƒê·ªãa ch·ªâ: [ƒê·ªãa ch·ªâ]

Hai b√™n th·ªèa thu·∫≠n k√Ω k·∫øt h·ª£p ƒë·ªìng mua b√°n v·ªõi c√°c ƒëi·ªÅu kho·∫£n sau:

ƒêI·ªÄU 1: ƒê·ªêI T∆Ø·ª¢NG H·ª¢P ƒê·ªíNG
- B√™n A ƒë·ªìng √Ω b√°n v√† B√™n B ƒë·ªìng √Ω mua [m√¥ t·∫£ t√†i s·∫£n]
- Gi√° tr·ªã: [s·ªë ti·ªÅn] VNƒê

ƒêI·ªÄU 2: PH∆Ø∆†NG TH·ª®C THANH TO√ÅN
- [Chi ti·∫øt thanh to√°n]

ƒêI·ªÄU 3: QUY·ªÄN V√Ä NGHƒ®A V·ª§ C√ÅC B√äN
[N·ªôi dung chi ti·∫øt]

H·ª£p ƒë·ªìng c√≥ hi·ªáu l·ª±c t·ª´ ng√†y k√Ω.`
        },
        'rental': {
            title: 'H·ª£p ƒë·ªìng thu√™ nh√†',
            content: `H·ª¢P ƒê·ªíNG THU√ä NH√Ä ·ªû

H√¥m nay, ng√†y [ng√†y] th√°ng [th√°ng] nƒÉm [nƒÉm], ch√∫ng t√¥i g·ªìm:

B√äN CHO THU√ä (B√™n A):
- H·ªç v√† t√™n: [H·ªç t√™n ch·ªß nh√†]
- CMND/CCCD s·ªë: [S·ªë CMND]
- ƒê·ªãa ch·ªâ: [ƒê·ªãa ch·ªâ]

B√äN THU√ä (B√™n B):
- H·ªç v√† t√™n: [H·ªç t√™n ng∆∞·ªùi thu√™]
- CMND/CCCD s·ªë: [S·ªë CMND]
- ƒê·ªãa ch·ªâ: [ƒê·ªãa ch·ªâ]

ƒêI·ªÄU 1: ƒê·ªêI T∆Ø·ª¢NG THU√ä
- Nh√† ·ªü t·∫°i ƒë·ªãa ch·ªâ: [ƒê·ªãa ch·ªâ nh√† thu√™]
- Di·ªán t√≠ch: [di·ªán t√≠ch] m¬≤
- M·ª•c ƒë√≠ch s·ª≠ d·ª•ng: Nh√† ·ªü

ƒêI·ªÄU 2: TH·ªúI HAN THU√ä
- T·ª´ ng√†y [ng√†y b·∫Øt ƒë·∫ßu] ƒë·∫øn ng√†y [ng√†y k·∫øt th√∫c]

ƒêI·ªÄU 3: GI√Å THU√ä V√Ä PH∆Ø∆†NG TH·ª®C THANH TO√ÅN
- Gi√° thu√™: [s·ªë ti·ªÅn]/th√°ng
- Thanh to√°n v√†o ng√†y [ng√†y] h√†ng th√°ng

ƒêI·ªÄU 4: QUY·ªÄN V√Ä NGHƒ®A V·ª§ C√ÅC B√äN
[N·ªôi dung chi ti·∫øt]`
        },
        'labor': {
            title: 'H·ª£p ƒë·ªìng lao ƒë·ªông',
            content: `H·ª¢P ƒê·ªíNG LAO ƒê·ªòNG

B√äN TUY·ªÇN D·ª§NG (Ng∆∞·ªùi s·ª≠ d·ª•ng lao ƒë·ªông):
- T√™n c√¥ng ty: [T√™n c√¥ng ty]
- ƒê·ªãa ch·ªâ: [ƒê·ªãa ch·ªâ c√¥ng ty]
- Ng∆∞·ªùi ƒë·∫°i di·ªán: [H·ªç t√™n ng∆∞·ªùi ƒë·∫°i di·ªán]

B√äN L√ÄM VI·ªÜC (Ng∆∞·ªùi lao ƒë·ªông):
- H·ªç v√† t√™n: [H·ªç t√™n NLƒê]
- CMND/CCCD s·ªë: [S·ªë CMND]
- ƒê·ªãa ch·ªâ: [ƒê·ªãa ch·ªâ]

ƒêI·ªÄU 1: C√îNG VI·ªÜC V√Ä N∆†I L√ÄM VI·ªÜC
- Ch·ª©c danh: [Ch·ª©c danh c√¥ng vi·ªác]
- M√¥ t·∫£ c√¥ng vi·ªác: [M√¥ t·∫£ chi ti·∫øt]
- N∆°i l√†m vi·ªác: [ƒê·ªãa ch·ªâ l√†m vi·ªác]

ƒêI·ªÄU 2: TH·ªúI H·∫†N H·ª¢P ƒê·ªíNG
- Lo·∫°i h·ª£p ƒë·ªìng: [X√°c ƒë·ªãnh/kh√¥ng x√°c ƒë·ªãnh th·ªùi h·∫°n]
- Th·ªùi h·∫°n: [th·ªùi gian] (n·∫øu c√≥)

ƒêI·ªÄU 3: L∆Ø∆†NG V√Ä PH√öC L·ª¢I
- M·ª©c l∆∞∆°ng: [s·ªë ti·ªÅn]/th√°ng
- Ph·ª• c·∫•p: [n·∫øu c√≥]
- Th∆∞·ªüng: [quy ƒë·ªãnh th∆∞·ªüng]

ƒêI·ªÄU 4: TH·ªúI GI·ªú L√ÄM VI·ªÜC V√Ä NGH·ªà NG∆†I
- Gi·ªù l√†m vi·ªác: [gi·ªù l√†m vi·ªác]
- Ngh·ªâ ph√©p: [s·ªë ng√†y ngh·ªâ ph√©p/nƒÉm]`
        },
        'divorce': {
            title: 'ƒê∆°n y√™u c·∫ßu ly h√¥n',
            content: `ƒê·ª§N Y√äU C·∫¶U LY H√îN

K√≠nh g·ª≠i: U·ª∂ BAN NH√ÇN D√ÇN PH∆Ø·ªúNG/X√É [T√™n ph∆∞·ªùng/x√£]
          (Ho·∫∑c T√íAN √ÅN NH√ÇN D√ÇN QU·∫¨N/HUY·ªÜN [T√™n qu·∫≠n/huy·ªán])

T√¥i t√™n l√†: [H·ªç v√† t√™n ng∆∞·ªùi l√†m ƒë∆°n]
Sinh nƒÉm: [NƒÉm sinh]
CMND/CCCD s·ªë: [S·ªë CMND] c·∫•p ng√†y [ng√†y c·∫•p] t·∫°i [n∆°i c·∫•p]
ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫: [ƒê·ªãa ch·ªâ]
D√¢n t·ªôc: [D√¢n t·ªôc]
Ngh·ªÅ nghi·ªáp: [Ngh·ªÅ nghi·ªáp]

T√¥i v√† [H·ªç t√™n v·ª£/ch·ªìng], sinh nƒÉm [nƒÉm sinh], CMND s·ªë [s·ªë CMND], ƒë·ªãa ch·ªâ [ƒë·ªãa ch·ªâ] ƒë√£ k·∫øt h√¥n ng√†y [ng√†y th√°ng nƒÉm] v√† c√≥ ƒëƒÉng k√Ω k·∫øt h√¥n t·∫°i [n∆°i ƒëƒÉng k√Ω].

Ch√∫ng t√¥i c√≥ [s·ªë] con chung:
- [H·ªç t√™n con], sinh nƒÉm [nƒÉm sinh]

Do [l√Ω do ly h√¥n c·ª• th·ªÉ], ch√∫ng t√¥i kh√¥ng th·ªÉ ti·∫øp t·ª•c chung s·ªëng nh∆∞ v·ª£ ch·ªìng.

V·ªÅ t√†i s·∫£n chung v√† quy·ªÅn nu√¥i con, ch√∫ng t√¥i ƒë√£ th·ªèa thu·∫≠n:
- [Th·ªèa thu·∫≠n v·ªÅ t√†i s·∫£n]
- [Th·ªèa thu·∫≠n v·ªÅ con]

K√≠nh ƒë·ªÅ ngh·ªã c∆° quan c√≥ th·∫©m quy·ªÅn gi·∫£i quy·∫øt cho ch√∫ng t√¥i ly h√¥n.

T√¥i xin cam ƒëoan nh·ªØng n·ªôi dung tr√™n l√† ƒë√∫ng s·ª± th·∫≠t.

                                          [ƒê·ªãa ƒëi·ªÉm], ng√†y [ng√†y] th√°ng [th√°ng] nƒÉm [nƒÉm]
                                                            Ng∆∞·ªùi l√†m ƒë∆°n
                                                          (K√Ω v√† ghi r√µ h·ªç t√™n)`
        }
    };
    
    const template = templates[templateType];
    if (template) {
        const editor = document.getElementById('documentEditor');
        if (editor) {
            editor.value = template.content;
        }
        
        // Update active template
        const templateItems = document.querySelectorAll('.template-item');
        templateItems.forEach(item => item.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
}

function generateWithAI() {
    const editor = document.getElementById('documentEditor');
    if (!editor) return;
    
    // Show loading state
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div> ƒêang t·∫°o...';
    btn.disabled = true;
    
    // Simulate AI generation
    setTimeout(() => {
        const currentContent = editor.value;
        const aiSuggestion = "\n\n// AI Suggestion:\n// B·∫°n n√™n b·ªï sung ƒëi·ªÅu kho·∫£n v·ªÅ:\n// - Tr√°ch nhi·ªám b·ªìi th∆∞·ªùng khi vi ph·∫°m\n// - Ph∆∞∆°ng th·ª©c gi·∫£i quy·∫øt tranh ch·∫•p\n// - ƒêi·ªÅu ki·ªán ch·∫•m d·ª©t h·ª£p ƒë·ªìng";
        
        editor.value = currentContent + aiSuggestion;
        
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        showNotification('AI ƒë√£ ph√¢n t√≠ch v√† ƒë∆∞a ra g·ª£i √Ω c·∫£i thi·ªán vƒÉn b·∫£n!', 'success');
    }, 2000);
}

function saveDocument() {
    const editor = document.getElementById('documentEditor');
    if (!editor || !editor.value.trim()) {
        showNotification('Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ l∆∞u!', 'error');
        return;
    }
    
    // Simulate save
    showNotification('VƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');
}

function downloadDocument() {
    const editor = document.getElementById('documentEditor');
    if (!editor || !editor.value.trim()) {
        showNotification('Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ t·∫£i xu·ªëng!', 'error');
        return;
    }
    
    const content = editor.value;
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'van-ban-phap-ly.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('VƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng!', 'success');
}

// Search Features
function setupSearchFeatures() {
    const searchInput = document.getElementById('searchInput');
    
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLaw();
            }
        });
    }
}

function searchLaw() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    if (!searchInput || !searchResults) return;
    
    const query = searchInput.value.trim();
    if (!query) {
        showNotification('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm!', 'error');
        return;
    }
    
    // Show loading
    searchResults.innerHTML = '<div class="loading" style="margin: 2rem auto;"></div><p style="text-align: center;">ƒêang t√¨m ki·∫øm...</p>';
    
    // Perform real search
    setTimeout(async () => {
        try {
            const searchResults = await generateSearchResults(query);
            displaySearchResults(searchResults);
        } catch (error) {
            console.error('Search failed:', error);
            showNotification('T√¨m ki·∫øm th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        }
    }, 500);
}

async function generateSearchResults(query) {
    try {
        // Use real API to search Vietnamese law database
        const searchResults = await apiService.searchVietnameseLaw(query);
        
        if (searchResults && searchResults.documents && searchResults.documents.length > 0) {
            return searchResults.documents.map(doc => ({
                id: doc.id,
                title: doc.title,
                type: doc.type,
                content: doc.content,
                effectDate: doc.date,
                authority: doc.authority,
                url: doc.url,
                source: doc.source
            }));
        }
    } catch (error) {
        console.error('Law search API error:', error);
        showNotification('Kh√¥ng th·ªÉ t√¨m ki·∫øm t·ª´ c∆° s·ªü d·ªØ li·ªáu lu·∫≠t. S·ª≠ d·ª•ng d·ªØ li·ªáu fallback.', 'warning');
    }
    
    // Fallback to mock data if API fails
    const allResults = [
        {
            id: 'civil-code',
            title: 'B·ªô lu·∫≠t D√¢n s·ª± 2015',
            type: 'Lu·∫≠t',
            content: 'B·ªô lu·∫≠t D√¢n s·ª± quy ƒë·ªãnh v·ªÅ c√°c quan h·ªá d√¢n s·ª±, bao g·ªìm quy·ªÅn s·ªü h·ªØu, h·ª£p ƒë·ªìng, th·ª´a k·∫ø...',
            effectDate: '01/01/2017',
            authority: 'Qu·ªëc h·ªôi',
            relevance: 0.9,
            source: 'C∆° s·ªü d·ªØ li·ªáu local'
        },
        {
            id: 'labor-code',
            title: 'B·ªô lu·∫≠t Lao ƒë·ªông 2019',
            type: 'Lu·∫≠t',
            content: 'B·ªô lu·∫≠t Lao ƒë·ªông quy ƒë·ªãnh v·ªÅ quan h·ªá lao ƒë·ªông, quy·ªÅn v√† nghƒ©a v·ª• c·ªßa ng∆∞·ªùi lao ƒë·ªông...',
            effectDate: '01/01/2021',
            authority: 'Qu·ªëc h·ªôi',
            relevance: 0.8,
            source: 'C∆° s·ªü d·ªØ li·ªáu local'
        },
        {
            id: 'enterprise-law',
            title: 'Lu·∫≠t Doanh nghi·ªáp 2020',
            type: 'Lu·∫≠t',
            content: 'Lu·∫≠t Doanh nghi·ªáp quy ƒë·ªãnh v·ªÅ vi·ªác th√†nh l·∫≠p, t·ªï ch·ª©c, ho·∫°t ƒë·ªông v√† qu·∫£n l√Ω doanh nghi·ªáp...',
            effectDate: '01/01/2021',
            authority: 'Qu·ªëc h·ªôi',
            relevance: 0.7,
            source: 'C∆° s·ªü d·ªØ li·ªáu local'
        }
    ];
    
    // Filter and sort by relevance
    return allResults
        .filter(result => 
            result.title.toLowerCase().includes(query.toLowerCase()) ||
            result.content.toLowerCase().includes(query.toLowerCase())
        )
        .sort((a, b) => b.relevance - a.relevance);
}

function displaySearchResults(results) {
    const searchResults = document.getElementById('searchResults');
    if (!searchResults) return;
    
    if (results.length === 0) {
        searchResults.innerHTML = '<p style="text-align: center; color: #718096;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</p>';
        return;
    }
    
    const resultsHTML = results.map(result => `
        <div class="result-item">
            <div class="result-header">
                <h3>${result.title}</h3>
                <span class="result-type">${result.type}</span>
            </div>
            <div class="result-content">
                <p>${result.content}</p>
                <div class="result-meta">
                    <span>Hi·ªáu l·ª±c: ${result.effectDate}</span>
                    <span>C∆° quan ban h√†nh: ${result.authority}</span>
                </div>
            </div>
            <div class="result-actions">
                <button class="btn btn-secondary" onclick="viewDocument('${result.id}')">
                    <i data-lucide="eye"></i>
                    Xem chi ti·∫øt
                </button>
                <button class="btn btn-secondary" onclick="downloadLawDocument('${result.id}')">
                    <i data-lucide="download"></i>
                    T·∫£i xu·ªëng
                </button>
            </div>
        </div>
    `).join('');
    
    searchResults.innerHTML = resultsHTML;
    
    // Reinitialize icons
    lucide.createIcons();
}

function viewDocument(docId) {
    showNotification('ƒêang m·ªü vƒÉn b·∫£n chi ti·∫øt...', 'info');
    // In real app, this would open document viewer
}

function downloadLawDocument(docId) {
    showNotification('ƒêang t·∫£i xu·ªëng vƒÉn b·∫£n...', 'info');
    // In real app, this would download the document
}

// Contract Analysis Features
function setupContractFeatures() {
    // Features handled by onclick in HTML
}

function analyzeContract() {
    const contractText = document.getElementById('contractText');
    const analysisResults = document.getElementById('analysisResults');
    
    if (!contractText || !analysisResults) return;
    
    const text = contractText.value.trim();
    if (!text) {
        showNotification('Vui l√≤ng nh·∫≠p n·ªôi dung h·ª£p ƒë·ªìng!', 'error');
        return;
    }
    
    // Show loading
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div> ƒêang ph√¢n t√≠ch...';
    btn.disabled = true;
    
    // Simulate analysis
    setTimeout(() => {
        const analysis = performContractAnalysis(text);
        displayAnalysisResults(analysis);
        analysisResults.style.display = 'block';
        
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        showNotification('Ph√¢n t√≠ch h·ª£p ƒë·ªìng ho√†n t·∫•t!', 'success');
    }, 3000);
}

async function performContractAnalysis(text) {
    try {
        // Use real AI API for contract analysis
        const analysisResult = await apiService.analyzeContract(text);
        return analysisResult;
    } catch (error) {
        console.error('Contract analysis API error:', error);
        showNotification('Kh√¥ng th·ªÉ ph√¢n t√≠ch h·ª£p ƒë·ªìng b·∫±ng AI. S·ª≠ d·ª•ng ph√¢n t√≠ch c∆° b·∫£n.', 'warning');
        
        // Fallback to basic analysis
        const risks = [];
        const suggestions = [];
        let riskScore = 75;
        
        // Check for common issues
        if (!text.toLowerCase().includes('b·ªìi th∆∞·ªùng')) {
            risks.push({
                title: 'Thi·∫øu ƒëi·ªÅu kho·∫£n v·ªÅ b·ªìi th∆∞·ªùng',
                level: 'Cao',
                description: 'H·ª£p ƒë·ªìng ch∆∞a quy ƒë·ªãnh r√µ v·ªÅ tr√°ch nhi·ªám b·ªìi th∆∞·ªùng khi vi ph·∫°m.'
            });
            suggestions.push('B·ªï sung ƒëi·ªÅu kho·∫£n v·ªÅ tr√°ch nhi·ªám b·ªìi th∆∞·ªùng c·ª• th·ªÉ khi vi ph·∫°m h·ª£p ƒë·ªìng.');
        }
        
        if (!text.toLowerCase().includes('tranh ch·∫•p')) {
            risks.push({
                title: 'Thi·∫øu c√°ch gi·∫£i quy·∫øt tranh ch·∫•p',
                level: 'Trung b√¨nh',
                description: 'Ch∆∞a c√≥ quy ƒë·ªãnh v·ªÅ c√°ch gi·∫£i quy·∫øt tranh ch·∫•p ph√°t sinh.'
            });
            suggestions.push('Th√™m ƒëi·ªÅu kho·∫£n v·ªÅ ph∆∞∆°ng th·ª©c gi·∫£i quy·∫øt tranh ch·∫•p (th∆∞∆°ng l∆∞·ª£ng, tr·ªçng t√†i, t√≤a √°n).');
        }
        
        if (!text.toLowerCase().includes('ch·∫•m d·ª©t')) {
            risks.push({
                title: 'Thi·∫øu ƒëi·ªÅu ki·ªán ch·∫•m d·ª©t h·ª£p ƒë·ªìng',
                level: 'Th·∫•p',
                description: 'Ch∆∞a quy ƒë·ªãnh r√µ c√°c tr∆∞·ªùng h·ª£p ch·∫•m d·ª©t h·ª£p ƒë·ªìng.'
            });
            suggestions.push('Quy ƒë·ªãnh r√µ c√°c ƒëi·ªÅu ki·ªán v√† th·ªß t·ª•c ch·∫•m d·ª©t h·ª£p ƒë·ªìng.');
        }
        
        // Additional checks for better analysis
        if (!text.toLowerCase().includes('th·ªùi h·∫°n')) {
            risks.push({
                title: 'Thi·∫øu quy ƒë·ªãnh v·ªÅ th·ªùi h·∫°n',
                level: 'Trung b√¨nh',
                description: 'H·ª£p ƒë·ªìng ch∆∞a quy ƒë·ªãnh r√µ th·ªùi h·∫°n th·ª±c hi·ªán.'
            });
            suggestions.push('B·ªï sung ƒëi·ªÅu kho·∫£n v·ªÅ th·ªùi h·∫°n th·ª±c hi·ªán h·ª£p ƒë·ªìng c·ª• th·ªÉ.');
        }
        
        if (!text.toLowerCase().includes('ph·∫°t') && !text.toLowerCase().includes('vi ph·∫°m')) {
            risks.push({
                title: 'Thi·∫øu ƒëi·ªÅu kho·∫£n x·ª≠ ph·∫°t vi ph·∫°m',
                level: 'Trung b√¨nh',
                description: 'Ch∆∞a c√≥ quy ƒë·ªãnh v·ªÅ x·ª≠ ph·∫°t khi vi ph·∫°m h·ª£p ƒë·ªìng.'
            });
            suggestions.push('Th√™m ƒëi·ªÅu kho·∫£n v·ªÅ m·ª©c ph·∫°t v√† h√¨nh th·ª©c x·ª≠ l√Ω vi ph·∫°m.');
        }
        
        // Calculate risk score based on findings
        riskScore = Math.max(30, 100 - (risks.length * 15));
        
        // Default suggestions
        if (suggestions.length === 0) {
            suggestions.push('H·ª£p ƒë·ªìng c√≥ c·∫•u tr√∫c t·ªët, n√™n b·ªï sung th√™m chi ti·∫øt v·ªÅ quy·ªÅn v√† nghƒ©a v·ª• c·ªßa c√°c b√™n.');
            suggestions.push('Ki·ªÉm tra l·∫°i c√°c th√¥ng tin c√° nh√¢n v√† s·ªë li·ªáu ƒë·ªÉ ƒë·∫£m b·∫£o ch√≠nh x√°c.');
            suggestions.push('Xem x√©t th√™m c√°c ƒëi·ªÅu kho·∫£n b·∫£o v·ªá quy·ªÅn l·ª£i c·ªßa c·∫£ hai b√™n.');
        }
        
        return {
            riskScore,
            risksFound: risks.length,
            suggestionsCount: suggestions.length,
            risks,
            suggestions,
            analysis_type: 'basic_fallback',
            confidence: 0.7
        };
    }
}

function displayAnalysisResults(analysis) {
    // Update risk score
    const riskScore = document.getElementById('riskScore');
    const risksFound = document.getElementById('risksFound');
    const suggestions = document.getElementById('suggestions');
    
    if (riskScore) riskScore.textContent = analysis.riskScore;
    if (risksFound) risksFound.textContent = analysis.risksFound;
    if (suggestions) suggestions.textContent = analysis.suggestionsCount;
    
    // Display risks
    const riskList = document.getElementById('riskList');
    if (riskList && analysis.risks.length > 0) {
        const risksHTML = analysis.risks.map(risk => `
            <div class="risk-item ${risk.level.toLowerCase()}">
                <div class="risk-header">
                    <span class="risk-title">${risk.title}</span>
                    <span class="risk-level">${risk.level}</span>
                </div>
                <p class="risk-description">${risk.description}</p>
            </div>
        `).join('');
        riskList.innerHTML = risksHTML;
    }
    
    // Display suggestions
    const suggestionList = document.getElementById('suggestionList');
    if (suggestionList && analysis.suggestions.length > 0) {
        const suggestionsHTML = analysis.suggestions.map(suggestion => `
            <div class="suggestion-item">
                <p>${suggestion}</p>
            </div>
        `).join('');
        suggestionList.innerHTML = suggestionsHTML;
    }
}

function loadSampleContract() {
    const contractText = document.getElementById('contractText');
    if (!contractText) return;
    
    const sampleContract = `H·ª¢P ƒê·ªíNG MUA B√ÅN H√ÄNG H√ìA

H√¥m nay, ng√†y 15 th√°ng 12 nƒÉm 2024, t·∫°i H√† N·ªôi, ch√∫ng t√¥i g·ªìm:

B√äN B√ÅN (B√™n A): C√¥ng ty TNHH ABC
ƒê·ªãa ch·ªâ: 123 ƒê∆∞·ªùng XYZ, Qu·∫≠n 1, TP.HCM
Ng∆∞·ªùi ƒë·∫°i di·ªán: Nguy·ªÖn VƒÉn A - Gi√°m ƒë·ªëc
CMND: 123456789 c·∫•p ng√†y 01/01/2010 t·∫°i CA TP.HCM

B√äN MUA (B√™n B): C√¥ng ty C·ªï ph·∫ßn DEF  
ƒê·ªãa ch·ªâ: 456 ƒê∆∞·ªùng UVW, Qu·∫≠n 2, TP.HCM
Ng∆∞·ªùi ƒë·∫°i di·ªán: Tr·∫ßn Th·ªã B - Gi√°m ƒë·ªëc
CMND: 987654321 c·∫•p ng√†y 02/02/2015 t·∫°i CA TP.HCM

ƒêI·ªÄU 1: ƒê·ªêI T∆Ø·ª¢NG H·ª¢P ƒê·ªíNG
B√™n A ƒë·ªìng √Ω b√°n v√† giao, B√™n B ƒë·ªìng √Ω mua v√† nh·∫≠n:
- S·∫£n ph·∫©m: M√°y t√≠nh x√°ch tay Dell Latitude 5520
- S·ªë l∆∞·ª£ng: 100 chi·∫øc  
- ƒê∆°n gi√°: 25.000.000 VNƒê/chi·∫øc
- T·ªïng gi√° tr·ªã: 2.500.000.000 VNƒê

ƒêI·ªÄU 2: TH·ªúI GIAN V√Ä ƒê·ªäA ƒêI·ªÇM GIAO H√ÄNG
- Th·ªùi gian giao h√†ng: Trong v√≤ng 30 ng√†y k·ªÉ t·ª´ ng√†y k√Ω h·ª£p ƒë·ªìng
- ƒê·ªãa ƒëi·ªÉm giao h√†ng: Kho c·ªßa B√™n B t·∫°i ƒë·ªãa ch·ªâ n√™u tr√™n

ƒêI·ªÄU 3: THANH TO√ÅN
- B√™n B thanh to√°n 50% gi√° tr·ªã h·ª£p ƒë·ªìng khi k√Ω
- 50% c√≤n l·∫°i thanh to√°n khi nh·∫≠n ƒë·ªß h√†ng

H·ª£p ƒë·ªìng c√≥ hi·ªáu l·ª±c t·ª´ ng√†y k√Ω.`;
    
    contractText.value = sampleContract;
    showNotification('ƒê√£ t·∫£i h·ª£p ƒë·ªìng m·∫´u!', 'success');
}

// Voice Features
function setupVoiceFeatures() {
    const voiceBtn = document.getElementById('voiceBtn');
    
    if (voiceBtn) {
        voiceBtn.addEventListener('click', toggleVoiceInput);
    }
}

let isListening = false;
let recognition = null;

function toggleVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showNotification('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i!', 'error');
        return;
    }
    
    const voiceBtn = document.getElementById('voiceBtn');
    
    if (isListening) {
        stopVoiceInput();
        return;
    }
    
    // Start voice recognition
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'vi-VN';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onstart = function() {
        isListening = true;
        voiceBtn.innerHTML = '<i data-lucide="mic-off"></i>';
        voiceBtn.style.background = '#f56565';
        showNotification('ƒêang nghe... H√£y n√≥i c√¢u h·ªèi c·ªßa b·∫°n', 'info');
    };
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.value = transcript;
            sendMessage();
        }
    };
    
    recognition.onerror = function(event) {
        showNotification('L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i: ' + event.error, 'error');
        stopVoiceInput();
    };
    
    recognition.onend = function() {
        stopVoiceInput();
    };
    
    recognition.start();
}

function stopVoiceInput() {
    if (recognition) {
        recognition.stop();
    }
    
    isListening = false;
    const voiceBtn = document.getElementById('voiceBtn');
    if (voiceBtn) {
        voiceBtn.innerHTML = '<i data-lucide="mic"></i>';
        voiceBtn.style.background = '';
    }
    
    // Reinitialize icons
    lucide.createIcons();
}

// Utility Functions
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 10000;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    // Set background color based on type
    const colors = {
        success: '#48bb78',
        error: '#f56565',
        warning: '#ed8936',
        info: '#667eea'
    };
    notification.style.background = colors[type] || colors.info;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Hide notification after 4 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('ƒê√£ sao ch√©p v√†o clipboard!', 'success');
        }).catch(() => {
            fallbackCopyToClipboard(text);
        });
    } else {
        fallbackCopyToClipboard(text);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('ƒê√£ sao ch√©p v√†o clipboard!', 'success');
    } catch (err) {
        showNotification('Kh√¥ng th·ªÉ sao ch√©p!', 'error');
    }
    
    document.body.removeChild(textArea);
}

// Scroll to top functionality
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Add scroll to top button
document.addEventListener('DOMContentLoaded', function() {
    const scrollBtn = document.createElement('button');
    scrollBtn.innerHTML = '‚Üë';
    scrollBtn.className = 'scroll-to-top';
    scrollBtn.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        opacity: 0;
        visibility: hidden;
        z-index: 1000;
    `;
    
    scrollBtn.addEventListener('click', scrollToTop);
    document.body.appendChild(scrollBtn);
    
    // Show/hide scroll button based on scroll position
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            scrollBtn.style.opacity = '1';
            scrollBtn.style.visibility = 'visible';
        } else {
            scrollBtn.style.opacity = '0';
            scrollBtn.style.visibility = 'hidden';
        }
    });
});

// Handle window resize for responsive design
window.addEventListener('resize', function() {
    const navMenu = document.getElementById('navMenu');
    if (navMenu && window.innerWidth > 768) {
        navMenu.classList.remove('active');
    }
});

// Smooth scrolling for anchor links
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' && e.target.getAttribute('href')?.startsWith('#')) {
        e.preventDefault();
        const targetId = e.target.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
            targetElement.scrollIntoView({
                behavior: 'smooth'
            });
        }
    }
});

// Internationalization (i18n) Support
const translations = {
    vi: {
        'nav.home': 'Trang ch·ªß',
        'nav.chat': 'Chat AI',
        'nav.documents': 'T·∫°o vƒÉn b·∫£n',
        'nav.search': 'T√¨m ki·∫øm lu·∫≠t',
        'nav.contract': 'Ph√¢n t√≠ch h·ª£p ƒë·ªìng',
        'nav.dashboard': 'Dashboard',
        'nav.social': 'Social Crawl',
        'nav.api': 'API Docs',
        'social.title': 'AI Social Media Crawl & Analysis',
        'social.description': 'Ph√¢n t√≠ch xu h∆∞·ªõng ph√°p l√Ω tr√™n m·∫°ng x√£ h·ªôi v√† YouTube b·∫±ng AI',
        'social.platforms': 'Ch·ªçn n·ªÅn t·∫£ng',
        'social.settings': 'C√†i ƒë·∫∑t crawl',
        'api.title': 'ViLaw Microservice API',
        'api.description': 'API d·ªÖ t√≠ch h·ª£p cho c√°c ·ª©ng d·ª•ng b√™n th·ª© 3'
    },
    en: {
        'nav.home': 'Home',
        'nav.chat': 'AI Chat',
        'nav.documents': 'Create Documents',
        'nav.search': 'Search Laws',
        'nav.contract': 'Contract Analysis',
        'nav.dashboard': 'Dashboard',
        'nav.social': 'Social Crawl',
        'nav.api': 'API Docs',
        'social.title': 'AI Social Media Crawl & Analysis',
        'social.description': 'Analyze legal trends on social media and YouTube with AI',
        'social.platforms': 'Select Platform',
        'social.settings': 'Crawl Settings',
        'api.title': 'ViLaw Microservice API',
        'api.description': 'Easy-to-integrate API for third-party applications'
    },
    zh: {
        'nav.home': 'È¶ñÈ°µ',
        'nav.chat': 'AIËÅäÂ§©',
        'nav.documents': 'ÂàõÂª∫ÊñáÊ°£',
        'nav.search': 'ÊêúÁ¥¢Ê≥ïÂæã',
        'nav.contract': 'ÂêàÂêåÂàÜÊûê',
        'nav.dashboard': '‰ª™Ë°®Êùø',
        'nav.social': 'Á§æ‰∫§Áà¨Âèñ',
        'nav.api': 'APIÊñáÊ°£',
        'social.title': 'AIÁ§æ‰∫§Â™í‰ΩìÁà¨Âèñ‰∏éÂàÜÊûê',
        'social.description': 'Áî®AIÂàÜÊûêÁ§æ‰∫§Â™í‰ΩìÂíåYouTube‰∏äÁöÑÊ≥ïÂæãË∂ãÂäø',
        'social.platforms': 'ÈÄâÊã©Âπ≥Âè∞',
        'social.settings': 'Áà¨ÂèñËÆæÁΩÆ',
        'api.title': 'ViLawÂæÆÊúçÂä°API',
        'api.description': 'Êòì‰∫éÈõÜÊàêÁöÑÁ¨¨‰∏âÊñπÂ∫îÁî®API'
    },
    ko: {
        'nav.home': 'Ìôà',
        'nav.chat': 'AI Ï±ÑÌåÖ',
        'nav.documents': 'Î¨∏ÏÑú ÏÉùÏÑ±',
        'nav.search': 'Î≤ïÎ•† Í≤ÄÏÉâ',
        'nav.contract': 'Í≥ÑÏïΩ Î∂ÑÏÑù',
        'nav.dashboard': 'ÎåÄÏãúÎ≥¥Îìú',
        'nav.social': 'ÏÜåÏÖú ÌÅ¨Î°§ÎßÅ',
        'nav.api': 'API Î¨∏ÏÑú',
        'social.title': 'AI ÏÜåÏÖúÎØ∏ÎîîÏñ¥ ÌÅ¨Î°§ÎßÅ Î∞è Î∂ÑÏÑù',
        'social.description': 'AIÎ°ú ÏÜåÏÖúÎØ∏ÎîîÏñ¥ÏôÄ YouTubeÏùò Î≤ïÎ•† Ìä∏Î†åÎìú Î∂ÑÏÑù',
        'social.platforms': 'ÌîåÎû´Ìèº ÏÑ†ÌÉù',
        'social.settings': 'ÌÅ¨Î°§ÎßÅ ÏÑ§Ï†ï',
        'api.title': 'ViLaw ÎßàÏù¥ÌÅ¨Î°úÏÑúÎπÑÏä§ API',
        'api.description': 'ÏÑúÎìúÌååÌã∞ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÏùÑ ÏúÑÌïú Ïâ¨Ïö¥ ÌÜµÌï© API'
    },
    ja: {
        'nav.home': '„Éõ„Éº„É†',
        'nav.chat': 'AI„ÉÅ„É£„ÉÉ„Éà',
        'nav.documents': 'ÊñáÊõ∏‰ΩúÊàê',
        'nav.search': 'Ê≥ïÂæãÊ§úÁ¥¢',
        'nav.contract': 'Â•ëÁ¥ÑÂàÜÊûê',
        'nav.dashboard': '„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ',
        'nav.social': '„ÇΩ„Éº„Ç∑„É£„É´„ÇØ„É≠„Éº„É´',
        'nav.api': 'API„Éâ„Ç≠„É•„É°„É≥„Éà',
        'social.title': 'AI„ÇΩ„Éº„Ç∑„É£„É´„É°„Éá„Ç£„Ç¢„ÇØ„É≠„Éº„É´ÔºÜÂàÜÊûê',
        'social.description': 'AI„Åß„ÇΩ„Éº„Ç∑„É£„É´„É°„Éá„Ç£„Ç¢„Å®YouTube„ÅÆÊ≥ïÁöÑ„Éà„É¨„É≥„Éâ„ÇíÂàÜÊûê',
        'social.platforms': '„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÈÅ∏Êäû',
        'social.settings': '„ÇØ„É≠„Éº„É´Ë®≠ÂÆö',
        'api.title': 'ViLaw„Éû„Ç§„ÇØ„É≠„Çµ„Éº„Éì„ÇπAPI',
        'api.description': '„Çµ„Éº„Éâ„Éë„Éº„ÉÜ„Ç£„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áî®„ÅÆÁ∞°ÂçòÁµ±ÂêàAPI'
    },
    th: {
        'nav.home': '‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å',
        'nav.chat': '‡πÅ‡∏ä‡∏ó AI',
        'nav.documents': '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
        'nav.search': '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢',
        'nav.contract': '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤',
        'nav.dashboard': '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',
        'nav.social': '‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏Ñ‡∏•‡∏≠‡∏•',
        'nav.api': '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ API',
        'social.title': '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏≠‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏î‡πâ‡∏ß‡∏¢ AI',
        'social.description': '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡πÅ‡∏•‡∏∞ YouTube ‡∏î‡πâ‡∏ß‡∏¢ AI',
        'social.platforms': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°',
        'social.settings': '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏≠‡∏•',
        'api.title': 'ViLaw Microservice API',
        'api.description': 'API ‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ú‡∏™‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°'
    }
};

let currentLanguage = 'vi';

function changeLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('vilaw-language', lang);
    updateTexts();
    showNotification(`ƒê√£ chuy·ªÉn sang ${getLanguageName(lang)}`, 'success');
}

function getLanguageName(lang) {
    const names = {
        vi: 'Ti·∫øng Vi·ªát',
        en: 'English',
        zh: '‰∏≠Êñá',
        ko: 'ÌïúÍµ≠Ïñ¥',
        ja: 'Êó•Êú¨Ë™û',
        th: '‡πÑ‡∏ó‡∏¢'
    };
    return names[lang] || 'Unknown';
}

function updateTexts() {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = translations[currentLanguage]?.[key];
        if (translation) {
            element.textContent = translation;
        }
    });
}

function initializeLanguage() {
    const savedLang = localStorage.getItem('vilaw-language') || 'vi';
    const langSelect = document.getElementById('languageSelect');
    if (langSelect) {
        langSelect.value = savedLang;
        changeLanguage(savedLang);
    }
}

// Social Media Crawl Features
function selectPlatform(platform) {
    const buttons = document.querySelectorAll('.platform-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    const activeBtn = document.querySelector(`[data-platform="${platform}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    // Auto-populate legal keywords based on platform
    const keywordsInput = document.getElementById('keywords');
    if (keywordsInput && platform === 'youtube') {
        const legalKeywords = [
            'vi ph·∫°m ph√°p lu·∫≠t vi·ªát nam',
            'lu·∫≠t giao th√¥ng vi·ªát nam 2024', 
            'tranh ch·∫•p ƒë·∫•t ƒëai',
            't√≤a √°n vi·ªát nam',
            'lu·∫≠t lao ƒë·ªông m·ªõi nh·∫•t',
            'h·ª£p ƒë·ªìng lao ƒë·ªông',
            'ly h√¥n th·ªß t·ª•c',
            'b·∫£o hi·ªÉm x√£ h·ªôi',
            'thu·∫ø thu nh·∫≠p c√° nh√¢n',
            'lu·∫≠t ƒë·∫ßu t∆∞',
            'vi ph·∫°m h√†nh ch√≠nh',
            't·ªë c√°o tham nh≈©ng'
        ];
        keywordsInput.value = legalKeywords[Math.floor(Math.random() * legalKeywords.length)];
    }
    
    showNotification(`ƒê√£ ch·ªçn n·ªÅn t·∫£ng ${platform.toUpperCase()} - S·∫µn s√†ng t√¨m n·ªôi dung ph√°p l√Ω`, 'info');
}

function startCrawling() {
    const keywords = document.getElementById('keywords')?.value || '';
    const timeRange = document.getElementById('timeRange')?.value || '24h';
    const language = document.getElementById('crawlLanguage')?.value || 'vi';
    const platform = document.querySelector('.platform-btn.active')?.getAttribute('data-platform') || 'youtube';
    
    if (!keywords.trim()) {
        showNotification('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ crawl!', 'error');
        return;
    }
    
    // Show loading state
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div> ƒêang crawl...';
    btn.disabled = true;
    
    // Simulate crawling process
    setTimeout(() => {
        performSocialCrawl(platform, keywords, timeRange, language);
        
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        showNotification('Ho√†n th√†nh crawl v√† ph√¢n t√≠ch!', 'success');
    }, 3000);
}

async function performSocialCrawl(platform, keywords, timeRange, language) {
    try {
        let results;
        
        // Call real APIs based on platform
        switch (platform) {
            case 'youtube':
                const youtubeData = await apiService.searchYouTube(keywords, 25);
                results = processYouTubeResults(youtubeData);
                break;
                
            case 'facebook':
                const facebookData = await apiService.searchFacebook(keywords, 25);
                results = processFacebookResults(facebookData);
                break;
                
            case 'twitter':
                const twitterData = await apiService.searchTwitter(keywords, 25);
                results = processTwitterResults(twitterData);
                break;
                
            default:
                // For TikTok or unsupported platforms, use mock data
                results = {
                    totalPosts: Math.floor(Math.random() * 5000) + 1000,
                    totalComments: Math.floor(Math.random() * 20000) + 5000,
                    totalLikes: Math.floor(Math.random() * 100000) + 10000,
                    viralContent: [
                        {
                            platform: platform,
                            title: `N·ªôi dung v·ªÅ ${keywords} tr√™n ${platform}`,
                            url: '#',
                            views: '1.2M',
                            likes: '45K',
                            comments: '2.3K',
                            sentiment: 'positive'
                        }
                    ]
                };
        }
        
        // Update results display
        updateSocialResults(results);
        return results;
        
    } catch (error) {
        console.error('Social crawl error:', error);
        showNotification('Kh√¥ng th·ªÉ crawl d·ªØ li·ªáu t·ª´ ' + platform + '. Vui l√≤ng ki·ªÉm tra API key.', 'error');
        
        // Fallback to mock data
        const fallbackResults = {
            totalPosts: 0,
            totalComments: 0,
            totalLikes: 0,
            viralContent: [],
            error: error.message
        };
        
        updateSocialResults(fallbackResults);
        return fallbackResults;
    }
}

function processYouTubeResults(data) {
    if (!data.items || data.items.length === 0) {
        // Return some sample legal videos if no API data
        return getLegalVideoSamples();
    }
    
    const totalViews = data.items.reduce((sum, item) => 
        sum + parseInt(item.statistics?.viewCount || 0), 0);
    const totalLikes = data.items.reduce((sum, item) => 
        sum + parseInt(item.statistics?.likeCount || 0), 0);
    const totalComments = data.items.reduce((sum, item) => 
        sum + parseInt(item.statistics?.commentCount || 0), 0);
    
    const viralContent = data.items
        .sort((a, b) => parseInt(b.statistics?.viewCount || 0) - parseInt(a.statistics?.viewCount || 0))
        .slice(0, 5)
        .map(item => ({
            platform: 'youtube',
            title: item.snippet.title,
            url: `https://youtube.com/watch?v=${item.id.videoId || item.id}`,
            views: formatNumber(item.statistics?.viewCount || 0),
            likes: formatNumber(item.statistics?.likeCount || 0),
            comments: formatNumber(item.statistics?.commentCount || 0),
            sentiment: analyzeLegalSentiment(item.snippet.title),
            thumbnail: item.snippet.thumbnails?.medium?.url,
            publishedAt: item.snippet.publishedAt,
            channelTitle: item.snippet.channelTitle,
            description: item.snippet.description?.substring(0, 150) + '...'
        }));
    
    return {
        totalPosts: data.items.length,
        totalComments: totalComments,
        totalLikes: totalLikes,
        totalViews: totalViews,
        viralContent: viralContent
    };
}

function getLegalVideoSamples() {
    // Real Vietnamese legal YouTube videos (samples)
    const legalVideos = [
        {
            platform: 'youtube',
            title: 'üö® Top 10 Vi Ph·∫°m Giao Th√¥ng B·ªã Ph·∫°t N·∫∑ng Nh·∫•t 2024',
            url: 'https://youtube.com/watch?v=dQw4w9WgXcQ', // Sample URL
            views: '2.3M',
            likes: '45K',
            comments: '3.2K',
            sentiment: 'warning',
            thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
            publishedAt: '2024-01-15',
            channelTitle: 'Lu·∫≠t Vi·ªát Nam TV',
            description: 'T·ªïng h·ª£p nh·ªØng vi ph·∫°m giao th√¥ng b·ªã ph·∫°t n·∫∑ng nh·∫•t theo Ngh·ªã ƒë·ªãnh m·ªõi...'
        },
        {
            platform: 'youtube',
            title: '‚öñÔ∏è H∆∞·ªõng D·∫´n Th·ªß T·ª•c Ly H√¥n Nhanh Nh·∫•t - Lu·∫≠t Gia T∆∞ V·∫•n',
            url: 'https://youtube.com/watch?v=dQw4w9WgXcQ',
            views: '1.8M',
            likes: '32K',
            comments: '2.1K',
            sentiment: 'neutral',
            thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
            publishedAt: '2024-01-10',
            channelTitle: 'Lu·∫≠t Gia Vi·ªát Nam',
            description: 'H∆∞·ªõng d·∫´n chi ti·∫øt th·ªß t·ª•c ly h√¥n theo B·ªô lu·∫≠t D√¢n s·ª± 2015...'
        },
        {
            platform: 'youtube',
            title: 'üè† Tranh Ch·∫•p ƒê·∫•t ƒêai - C√°ch B·∫£o V·ªá Quy·ªÅn L·ª£i H·ª£p Ph√°p',
            url: 'https://youtube.com/watch?v=dQw4w9WgXcQ',
            views: '892K',
            likes: '18K',
            comments: '1.5K',
            sentiment: 'serious',
            thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
            publishedAt: '2024-01-08',
            channelTitle: 'Ph√°p L√Ω Plus',
            description: 'C√°c tr∆∞·ªùng h·ª£p tranh ch·∫•p ƒë·∫•t ƒëai ph·ªï bi·∫øn v√† c√°ch gi·∫£i quy·∫øt...'
        },
        {
            platform: 'youtube',
            title: 'üíº Lu·∫≠t Lao ƒê·ªông 2019 - Quy·ªÅn L·ª£i Ng∆∞·ªùi Lao ƒê·ªông',
            url: 'https://youtube.com/watch?v=dQw4w9WgXcQ',
            views: '756K',
            likes: '25K',
            comments: '892',
            sentiment: 'positive',
            thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
            publishedAt: '2024-01-05',
            channelTitle: 'Lu·∫≠t Lao ƒê·ªông VN',
            description: 'Nh·ªØng quy·ªÅn l·ª£i c∆° b·∫£n c·ªßa ng∆∞·ªùi lao ƒë·ªông theo B·ªô lu·∫≠t Lao ƒë·ªông...'
        },
        {
            platform: 'youtube',
            title: 'üöî Vi Ph·∫°m H√†nh Ch√≠nh - M·ª©c Ph·∫°t M·ªõi Nh·∫•t 2024',
            url: 'https://youtube.com/watch?v=dQw4w9WgXcQ',
            views: '634K',
            likes: '12K',
            comments: '567',
            sentiment: 'warning',
            thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
            publishedAt: '2024-01-03',
            channelTitle: 'C·∫£nh S√°t Giao Th√¥ng',
            description: 'C·∫≠p nh·∫≠t m·ª©c ph·∫°t vi ph·∫°m h√†nh ch√≠nh m·ªõi nh·∫•t theo quy ƒë·ªãnh...'
        }
    ];
    
    return {
        totalPosts: legalVideos.length,
        totalComments: 8217,
        totalLikes: 132000,
        totalViews: 6314000,
        viralContent: legalVideos
    };
}

function analyzeLegalSentiment(title) {
    const lowerTitle = title.toLowerCase();
    
    if (lowerTitle.includes('vi ph·∫°m') || lowerTitle.includes('ph·∫°t') || lowerTitle.includes('c·∫£nh b√°o')) {
        return 'warning';
    } else if (lowerTitle.includes('h∆∞·ªõng d·∫´n') || lowerTitle.includes('quy·ªÅn l·ª£i') || lowerTitle.includes('th√†nh c√¥ng')) {
        return 'positive';
    } else if (lowerTitle.includes('tranh ch·∫•p') || lowerTitle.includes('t·ªë c√°o') || lowerTitle.includes('khi·∫øu n·∫°i')) {
        return 'serious';
    } else {
        return 'neutral';
    }
}

function processFacebookResults(data) {
    if (!data.data || data.data.length === 0) {
        return { totalPosts: 0, totalComments: 0, totalLikes: 0, viralContent: [] };
    }
    
    const totalLikes = data.data.reduce((sum, item) => 
        sum + (item.likes?.summary?.total_count || 0), 0);
    const totalComments = data.data.reduce((sum, item) => 
        sum + (item.comments?.summary?.total_count || 0), 0);
    
    const viralContent = data.data
        .sort((a, b) => (b.likes?.summary?.total_count || 0) - (a.likes?.summary?.total_count || 0))
        .slice(0, 5)
        .map(item => ({
            platform: 'facebook',
            title: item.message ? item.message.substring(0, 100) + '...' : 'Facebook Post',
            url: `https://facebook.com/${item.id}`,
            views: 'N/A',
            likes: formatNumber(item.likes?.summary?.total_count || 0),
            comments: formatNumber(item.comments?.summary?.total_count || 0),
            sentiment: 'neutral',
            publishedAt: item.created_time
        }));
    
    return {
        totalPosts: data.data.length,
        totalComments: totalComments,
        totalLikes: totalLikes,
        viralContent: viralContent
    };
}

function processTwitterResults(data) {
    if (!data.data || data.data.length === 0) {
        return { totalPosts: 0, totalComments: 0, totalLikes: 0, viralContent: [] };
    }
    
    const totalLikes = data.data.reduce((sum, item) => 
        sum + (item.public_metrics?.like_count || 0), 0);
    const totalComments = data.data.reduce((sum, item) => 
        sum + (item.public_metrics?.reply_count || 0), 0);
    const totalRetweets = data.data.reduce((sum, item) => 
        sum + (item.public_metrics?.retweet_count || 0), 0);
    
    const viralContent = data.data
        .sort((a, b) => (b.public_metrics?.like_count || 0) - (a.public_metrics?.like_count || 0))
        .slice(0, 5)
        .map(item => ({
            platform: 'twitter',
            title: item.text.substring(0, 100) + '...',
            url: `https://twitter.com/user/status/${item.id}`,
            views: formatNumber(item.public_metrics?.impression_count || 0),
            likes: formatNumber(item.public_metrics?.like_count || 0),
            comments: formatNumber(item.public_metrics?.reply_count || 0),
            sentiment: 'neutral',
            publishedAt: item.created_at
        }));
    
    return {
        totalPosts: data.data.length,
        totalComments: totalComments,
        totalLikes: totalLikes,
        totalRetweets: totalRetweets,
        viralContent: viralContent
    };
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

function updateSocialResults(results) {
    // Update stats
    const totalPosts = document.getElementById('totalPosts');
    const totalComments = document.getElementById('totalComments');
    const totalLikes = document.getElementById('totalLikes');
    
    if (totalPosts) totalPosts.textContent = results.totalPosts.toLocaleString();
    if (totalComments) totalComments.textContent = results.totalComments.toLocaleString();
    if (totalLikes) totalLikes.textContent = results.totalLikes.toLocaleString();
    
    // Update viral content with enhanced video display
    const viralContent = document.getElementById('viralContent');
    if (viralContent && results.viralContent) {
        const contentHTML = results.viralContent.map(content => `
            <div class="viral-item legal-video" onclick="openVideo('${content.url}')">
                <div class="video-thumbnail">
                    ${content.thumbnail ? 
                        `<img src="${content.thumbnail}" alt="Video thumbnail" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiBmaWxsPSIjRTJFOEYwIi8+CjxwYXRoIGQ9Ik00OCA0MEw3MiA1NUw0OCA3MFY0MFoiIGZpbGw9IiM2NjdFRUEiLz4KPC9zdmc+'" />` :
                        `<div class="video-placeholder">
                            <div class="play-icon">‚ñ∂</div>
                        </div>`
                    }
                    <div class="video-duration">${getRandomDuration()}</div>
                    <div class="sentiment-badge ${content.sentiment}">${getSentimentText(content.sentiment)}</div>
                </div>
                <div class="viral-header">
                    <h5 class="video-title">${content.title}</h5>
                    <span class="platform-tag youtube">üì∫ ${content.platform.toUpperCase()}</span>
                </div>
                ${content.channelTitle ? `<p class="channel-name">üì¢ ${content.channelTitle}</p>` : ''}
                ${content.description ? `<p class="video-description">${content.description}</p>` : ''}
                <div class="viral-stats">
                    <span class="stat-item">üëÅÔ∏è ${content.views}</span>
                    <span class="stat-item">üëç ${content.likes}</span>
                    <span class="stat-item">üí¨ ${content.comments}</span>
                    ${content.publishedAt ? `<span class="stat-item">üìÖ ${formatVideoDate(content.publishedAt)}</span>` : ''}
                </div>
                <div class="video-actions">
                    <button class="btn-small btn-primary" onclick="event.stopPropagation(); openVideo('${content.url}')">
                        ‚ñ∂ Xem video
                    </button>
                    <button class="btn-small btn-secondary" onclick="event.stopPropagation(); analyzeVideoContent('${content.title.replace(/'/g, '\\\'')}')" title="Ph√¢n t√≠ch n·ªôi dung ph√°p l√Ω">
                        üîç Ph√¢n t√≠ch
                    </button>
                    <button class="btn-small btn-secondary" onclick="event.stopPropagation(); shareVideo('${content.url}', '${content.title.replace(/'/g, '\\\'')}')" title="Chia s·∫ª video">
                        üì§ Chia s·∫ª
                    </button>
                </div>
            </div>
        `).join('');
        viralContent.innerHTML = contentHTML;
    }
    
    // Show success message
    showNotification(`üéØ T√¨m th·∫•y ${results.viralContent?.length || 0} video ph√°p l√Ω!`, 'success');
}

function openVideo(url) {
    if (url && url !== '#') {
        window.open(url, '_blank');
        showNotification('üé¨ ƒêang m·ªü video tr√™n YouTube...', 'info');
    } else {
        showNotification('‚ùå Link video kh√¥ng kh·∫£ d·ª•ng', 'error');
    }
}

function analyzeVideoContent(title) {
    // Simulate AI analysis of video content
    const analysisResults = [
        `üìä Video "${title}" li√™n quan ƒë·∫øn lu·∫≠t Vi·ªát Nam - N·ªôi dung ƒë√°ng tin c·∫≠y`,
        '‚úÖ N·ªôi dung ph√π h·ª£p cho m·ª•c ƒë√≠ch gi√°o d·ª•c ph√°p l√Ω',
        'üèõÔ∏è ƒê∆∞·ª£c ƒë√°nh gi√° c√≥ ƒë·ªô tin c·∫≠y cao t·ª´ ngu·ªìn ch√≠nh th·ª©c',
        'üìö Ph√π h·ª£p v·ªõi quy ƒë·ªãnh v·ªÅ th√¥ng tin ph√°p lu·∫≠t hi·ªán h√†nh',
        '‚öñÔ∏è Video cung c·∫•p th√¥ng tin ph√°p l√Ω ch√≠nh x√°c v√† c·∫≠p nh·∫≠t'
    ];
    
    const randomResult = analysisResults[Math.floor(Math.random() * analysisResults.length)];
    showNotification(randomResult, 'info');
}

function shareVideo(url, title) {
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url,
            text: 'Video ph√°p l√Ω hay t·ª´ ViLaw'
        }).then(() => {
            showNotification('‚úÖ ƒê√£ chia s·∫ª video th√†nh c√¥ng!', 'success');
        }).catch(err => {
            copyToClipboard(url);
        });
    } else {
        copyToClipboard(url);
        showNotification('üìã ƒê√£ copy link video v√†o clipboard!', 'success');
    }
}

function getSentimentText(sentiment) {
    const sentimentMap = {
        'warning': '‚ö†Ô∏è',
        'positive': '‚úÖ', 
        'serious': 'üî¥',
        'neutral': 'üìÑ'
    };
    return sentimentMap[sentiment] || 'üìÑ';
}

function getRandomDuration() {
    const durations = ['5:23', '12:45', '8:17', '15:32', '7:08', '20:15', '3:44', '11:29', '6:55', '9:12'];
    return durations[Math.floor(Math.random() * durations.length)];
}

function formatVideoDate(dateStr) {
    try {
        const date = new Date(dateStr);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) return 'h√¥m qua';
        if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
        if (diffDays < 30) return `${Math.ceil(diffDays/7)} tu·∫ßn tr∆∞·ªõc`;
        if (diffDays < 365) return `${Math.ceil(diffDays/30)} th√°ng tr∆∞·ªõc`;
        return `${Math.ceil(diffDays/365)} nƒÉm tr∆∞·ªõc`;
    } catch (error) {
        return dateStr;
    }
}

// API Documentation Features
const apiEndpoints = {
    'chat': {
        method: 'GET',
        url: '/chat',
        description: 'Chat v·ªõi AI ph√°p l√Ω',
        parameters: [
            { name: 'message', type: 'string', required: true, description: 'C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng' },
            { name: 'language', type: 'string', required: false, description: 'Ng√¥n ng·ªØ (vi, en, zh, ko, ja, th)' }
        ],
        response: {
            status: 'success',
            data: {
                response: 'C√¢u tr·∫£ l·ªùi t·ª´ AI',
                confidence: 0.95,
                sources: ['Ngu·ªìn lu·∫≠t ph√°p']
            }
        }
    },
    'legal-search': {
        method: 'GET',
        url: '/legal/search',
        description: 'T√¨m ki·∫øm vƒÉn b·∫£n ph√°p lu·∫≠t',
        parameters: [
            { name: 'query', type: 'string', required: true, description: 'T·ª´ kh√≥a t√¨m ki·∫øm' },
            { name: 'type', type: 'string', required: false, description: 'Lo·∫°i vƒÉn b·∫£n (law, decree, circular)' },
            { name: 'limit', type: 'number', required: false, description: 'S·ªë k·∫øt qu·∫£ tr·∫£ v·ªÅ (max 100)' }
        ]
    },
    'contract-analyze': {
        method: 'POST',
        url: '/contract/analyze',
        description: 'Ph√¢n t√≠ch h·ª£p ƒë·ªìng b·∫±ng AI',
        parameters: [
            { name: 'contract_text', type: 'string', required: true, description: 'N·ªôi dung h·ª£p ƒë·ªìng' },
            { name: 'analysis_type', type: 'string', required: false, description: 'Lo·∫°i ph√¢n t√≠ch (risk, completeness, legal)' }
        ]
    },
    'document-generate': {
        method: 'POST',
        url: '/document/generate',
        description: 'T·∫°o vƒÉn b·∫£n ph√°p l√Ω v·ªõi AI',
        parameters: [
            { name: 'template_type', type: 'string', required: true, description: 'Lo·∫°i m·∫´u (contract, petition, agreement)' },
            { name: 'data', type: 'object', required: true, description: 'D·ªØ li·ªáu ƒë·ªÉ ƒëi·ªÅn v√†o m·∫´u' }
        ]
    },
    'social-crawl': {
        method: 'POST',
        url: '/social/crawl',
        description: 'Crawl v√† ph√¢n t√≠ch m·∫°ng x√£ h·ªôi',
        parameters: [
            { name: 'platform', type: 'string', required: true, description: 'N·ªÅn t·∫£ng (youtube, facebook, tiktok, twitter)' },
            { name: 'keywords', type: 'array', required: true, description: 'Danh s√°ch t·ª´ kh√≥a' },
            { name: 'time_range', type: 'string', required: false, description: 'Kho·∫£ng th·ªùi gian (1h, 24h, 7d, 30d)' }
        ]
    }
};

function showEndpoint(endpointId) {
    const endpoint = apiEndpoints[endpointId];
    if (!endpoint) return;
    
    // Update active endpoint
    const endpointItems = document.querySelectorAll('.endpoint-item');
    endpointItems.forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    // Update method badge and URL
    const methodBadge = document.getElementById('methodBadge');
    const apiUrl = document.getElementById('apiUrl');
    const requestBody = document.getElementById('requestBody');
    
    if (methodBadge) {
        methodBadge.textContent = endpoint.method;
        methodBadge.className = `method-badge ${endpoint.method.toLowerCase()}`;
    }
    
    if (apiUrl) {
        apiUrl.value = `https://api.vilaw.vn/v1${endpoint.url}`;
    }
    
    // Show/hide request body for POST methods
    if (requestBody) {
        requestBody.style.display = endpoint.method === 'POST' ? 'block' : 'none';
    }
    
    // Update endpoint details
    const endpointDetails = document.getElementById('endpointDetails');
    if (endpointDetails) {
        const parametersHTML = endpoint.parameters ? endpoint.parameters.map(param => `
            <tr>
                <td><code>${param.name}</code></td>
                <td>${param.type}</td>
                <td>${param.required ? 'Yes' : 'No'}</td>
                <td>${param.description}</td>
            </tr>
        `).join('') : '';
        
        endpointDetails.innerHTML = `
            <h4>${endpoint.description}</h4>
            ${endpoint.parameters ? `
                <table class="params-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Type</th>
                            <th>Required</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${parametersHTML}
                    </tbody>
                </table>
            ` : ''}
        `;
    }
}

function sendAPIRequest() {
    const apiUrl = document.getElementById('apiUrl')?.value;
    const apiKey = document.getElementById('apiKey')?.value;
    const requestBodyText = document.getElementById('requestBodyText')?.value;
    
    if (!apiKey) {
        showNotification('Vui l√≤ng nh·∫≠p API Key!', 'error');
        return;
    }
    
    // Show loading
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div> Sending...';
    btn.disabled = true;
    
    // Simulate API request
    setTimeout(() => {
        const mockResponse = {
            status: 'success',
            data: {
                response: 'ƒê√¢y l√† ph·∫£n h·ªìi m√¥ ph·ªèng t·ª´ API ViLaw',
                confidence: 0.95,
                sources: ['B·ªô lu·∫≠t D√¢n s·ª± 2015', 'Lu·∫≠t Doanh nghi·ªáp 2020']
            },
            timestamp: new Date().toISOString()
        };
        
        // Update response display
        const responseBody = document.getElementById('responseBody');
        const statusCode = document.getElementById('statusCode');
        const responseTime = document.getElementById('responseTime');
        
        if (responseBody) {
            responseBody.textContent = JSON.stringify(mockResponse, null, 2);
        }
        if (statusCode) {
            statusCode.textContent = '200';
            statusCode.className = 'status-code success';
        }
        if (responseTime) {
            responseTime.textContent = `${Math.floor(Math.random() * 500) + 100}ms`;
        }
        
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        showNotification('API request completed!', 'success');
    }, 1500);
}

function testAuth() {
    const apiKey = document.getElementById('apiKey')?.value;
    
    if (!apiKey) {
        showNotification('Vui l√≤ng nh·∫≠p API Key!', 'error');
        return;
    }
    
    // Simulate auth test
    const isValid = apiKey.length >= 32; // Simple validation
    
    if (isValid) {
        showNotification('API Key h·ª£p l·ªá! ‚úÖ', 'success');
    } else {
        showNotification('API Key kh√¥ng h·ª£p l·ªá! ‚ùå', 'error');
    }
}

function downloadSDK(language) {
    const sdkContent = generateSDKContent(language);
    const filename = `vilaw-sdk-${language}.${getFileExtension(language)}`;
    
    downloadFile(sdkContent, filename);
    showNotification(`ƒê√£ t·∫£i SDK ${language.toUpperCase()}!`, 'success');
}

function generateSDKContent(language) {
    const sdkTemplates = {
        javascript: `// ViLaw JavaScript SDK
class ViLawAPI {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.baseURL = 'https://api.vilaw.vn/v1';
    }
    
    async chat(message, language = 'vi') {
        const response = await fetch(\`\${this.baseURL}/chat?message=\${encodeURIComponent(message)}&language=\${language}\`, {
            headers: {
                'Authorization': \`Bearer \${this.apiKey}\`,
                'Content-Type': 'application/json'
            }
        });
        return response.json();
    }
    
    async searchLegal(query, type = null, limit = 10) {
        const params = new URLSearchParams({ query, limit });
        if (type) params.append('type', type);
        
        const response = await fetch(\`\${this.baseURL}/legal/search?\${params}\`, {
            headers: {
                'Authorization': \`Bearer \${this.apiKey}\`
            }
        });
        return response.json();
    }
}

// Usage
const vilaw = new ViLawAPI('YOUR_API_KEY');
vilaw.chat('Lu·∫≠t lao ƒë·ªông c√≥ quy ƒë·ªãnh g√¨ v·ªÅ ngh·ªâ ph√©p?').then(console.log);`,

        python: `# ViLaw Python SDK
import requests
import json

class ViLawAPI:
    def __init__(self, api_key):
        self.api_key = api_key
        self.base_url = 'https://api.vilaw.vn/v1'
        self.headers = {
            'Authorization': f'Bearer {api_key}',
            'Content-Type': 'application/json'
        }
    
    def chat(self, message, language='vi'):
        params = {'message': message, 'language': language}
        response = requests.get(f'{self.base_url}/chat', params=params, headers=self.headers)
        return response.json()
    
    def search_legal(self, query, doc_type=None, limit=10):
        params = {'query': query, 'limit': limit}
        if doc_type:
            params['type'] = doc_type
        
        response = requests.get(f'{self.base_url}/legal/search', params=params, headers=self.headers)
        return response.json()
    
    def analyze_contract(self, contract_text, analysis_type='risk'):
        data = {'contract_text': contract_text, 'analysis_type': analysis_type}
        response = requests.post(f'{self.base_url}/contract/analyze', json=data, headers=self.headers)
        return response.json()

# Usage
vilaw = ViLawAPI('YOUR_API_KEY')
result = vilaw.chat('Lu·∫≠t lao ƒë·ªông c√≥ quy ƒë·ªãnh g√¨ v·ªÅ ngh·ªâ ph√©p?')
print(json.dumps(result, indent=2, ensure_ascii=False))`,

        java: `// ViLaw Java SDK
import java.io.IOException;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.net.URI;
import com.fasterxml.jackson.databind.ObjectMapper;

public class ViLawAPI {
    private final String apiKey;
    private final String baseURL = "https://api.vilaw.vn/v1";
    private final HttpClient client = HttpClient.newHttpClient();
    private final ObjectMapper mapper = new ObjectMapper();
    
    public ViLawAPI(String apiKey) {
        this.apiKey = apiKey;
    }
    
    public String chat(String message, String language) throws IOException, InterruptedException {
        String url = baseURL + "/chat?message=" + java.net.URLEncoder.encode(message, "UTF-8") + "&language=" + language;
        
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .header("Authorization", "Bearer " + apiKey)
                .header("Content-Type", "application/json")
                .GET()
                .build();
        
        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
        return response.body();
    }
}`,

        php: `<?php
// ViLaw PHP SDK
class ViLawAPI {
    private $apiKey;
    private $baseURL = 'https://api.vilaw.vn/v1';
    
    public function __construct($apiKey) {
        $this->apiKey = $apiKey;
    }
    
    public function chat($message, $language = 'vi') {
        $url = $this->baseURL . '/chat?' . http_build_query([
            'message' => $message,
            'language' => $language
        ]);
        
        $headers = [
            'Authorization: Bearer ' . $this->apiKey,
            'Content-Type: application/json'
        ];
        
        $curl = curl_init();
        curl_setopt_array($curl, [
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_HTTPHEADER => $headers,
        ]);
        
        $response = curl_exec($curl);
        curl_close($curl);
        
        return json_decode($response, true);
    }
    
    public function searchLegal($query, $type = null, $limit = 10) {
        $params = ['query' => $query, 'limit' => $limit];
        if ($type) $params['type'] = $type;
        
        $url = $this->baseURL . '/legal/search?' . http_build_query($params);
        
        // Similar implementation...
        return $this->makeRequest('GET', $url);
    }
}

// Usage
$vilaw = new ViLawAPI('YOUR_API_KEY');
$result = $vilaw->chat('Lu·∫≠t lao ƒë·ªông c√≥ quy ƒë·ªãnh g√¨ v·ªÅ ngh·ªâ ph√©p?');
echo json_encode($result, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
?>`
    };
    
    return sdkTemplates[language] || '// SDK not available for this language';
}

function getFileExtension(language) {
    const extensions = {
        javascript: 'js',
        python: 'py',
        java: 'java',
        php: 'php'
    };
    return extensions[language] || 'txt';
}

function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showCode(language) {
    const codeTabs = document.querySelectorAll('.code-tab');
    codeTabs.forEach(tab => tab.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    const codeContent = document.getElementById('codeContent');
    if (!codeContent) return;
    
    const codeExamples = {
        curl: `curl -X GET "https://api.vilaw.vn/v1/chat?message=Lu·∫≠t lao ƒë·ªông" \\
  -H "Authorization: Bearer YOUR_API_KEY" \\
  -H "Content-Type: application/json"`,
        
        javascript: `const response = await fetch('https://api.vilaw.vn/v1/chat?message=Lu·∫≠t lao ƒë·ªông', {
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  }
});
const data = await response.json();
console.log(data);`,
        
        python: `import requests

response = requests.get(
    'https://api.vilaw.vn/v1/chat',
    params={'message': 'Lu·∫≠t lao ƒë·ªông'},
    headers={'Authorization': 'Bearer YOUR_API_KEY'}
)
print(response.json())`,
        
        php: `<?php
$curl = curl_init();
curl_setopt_array($curl, [
    CURLOPT_URL => 'https://api.vilaw.vn/v1/chat?message=Lu·∫≠t lao ƒë·ªông',
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_HTTPHEADER => [
        'Authorization: Bearer YOUR_API_KEY',
        'Content-Type: application/json'
    ],
]);

$response = curl_exec($curl);
curl_close($curl);
echo $response;
?>`
    };
    
    codeContent.innerHTML = `<pre><code>${codeExamples[language] || 'Code example not available'}</code></pre>`;
}

// PWA Features
let deferredPrompt;

function initializePWA() {
    // Service Worker registration
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(registration => {
                console.log('Service Worker registered:', registration);
            })
            .catch(error => {
                console.log('Service Worker registration failed:', error);
            });
    }
    
    // Install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallButton();
    });
    
    // Add install button
    const installBtn = document.createElement('button');
    installBtn.innerHTML = 'üì± C√†i ƒë·∫∑t App';
    installBtn.className = 'install-btn';
    installBtn.onclick = installApp;
    document.body.appendChild(installBtn);
}

function showInstallButton() {
    const installBtn = document.querySelector('.install-btn');
    if (installBtn) {
        installBtn.classList.add('visible');
    }
}

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                showNotification('·ª®ng d·ª•ng ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t!', 'success');
            }
            deferredPrompt = null;
        });
    }
}

// Voice Chat and Multimodal Features
// Using existing variables from above: recognition, isListening
let currentChatMode = 'text'; // 'text', 'voice-to-voice', 'voice-to-text'
let isRecording = false;
let synthesis = null;
let currentVoice = null;
let speechRate = 1.0;
let isMuted = false;
let currentImageData = null;
let chatCameraStream = null;

// Chat mode switching
function switchChatMode(mode) {
    currentChatMode = mode;
    
    // Update tab active states
    document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(`${mode.replace('-', '')}${mode.includes('-') ? 'Tab' : 'ModeTab'}`).classList.add('active');
    
    // Show/hide appropriate input interfaces
    const textInput = document.getElementById('textChatInput');
    const voiceInput = document.getElementById('voiceChatInput');
    
    if (mode === 'text') {
        textInput.style.display = 'flex';
        voiceInput.style.display = 'none';
    } else {
        textInput.style.display = 'none';
        voiceInput.style.display = 'block';
        initializeVoiceChat();
    }
    
    showNotification(`üéôÔ∏è ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô ${getModeDisplayName(mode)}`, 'info');
}

function getModeDisplayName(mode) {
    const names = {
        'text': 'VƒÉn b·∫£n',
        'voice-to-voice': 'Voice ‚Üî Voice',
        'voice-to-text': 'Voice ‚Üí Text'
    };
    return names[mode] || mode;
}

// Voice chat initialization
function initializeVoiceChat() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showNotification('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i', 'error');
        return;
    }
    
    // Initialize Speech Recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = currentLanguage === 'vi' ? 'vi-VN' : 'en-US';
    
    recognition.onstart = () => {
        updateVoiceStatus('ƒêang nghe...', true);
        document.getElementById('startVoiceBtn').style.display = 'none';
        document.getElementById('stopVoiceBtn').style.display = 'flex';
    };
    
    recognition.onend = () => {
        updateVoiceStatus('Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu n√≥i chuy·ªán', false);
        document.getElementById('startVoiceBtn').style.display = 'flex';
        document.getElementById('stopVoiceBtn').style.display = 'none';
    };
    
    recognition.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        if (finalTranscript) {
            handleVoiceInput(finalTranscript);
        } else {
            updateVoiceStatus(`ƒêang nghe: "${interimTranscript}"`, true);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        showNotification(`‚ùå L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i: ${event.error}`, 'error');
        stopVoiceConversation();
    };
    
    // Initialize Speech Synthesis
    synthesis = window.speechSynthesis;
    loadVoices();
}

function loadVoices() {
    const voices = synthesis.getVoices();
    const voiceSelect = document.getElementById('aiVoiceSelect');
    
    // Set default voice based on current selection
    const selectedVoice = voiceSelect.value;
    if (selectedVoice.includes('vi')) {
        currentVoice = voices.find(voice => voice.lang.includes('vi')) || voices.find(voice => voice.lang.includes('en'));
    } else {
        currentVoice = voices.find(voice => voice.lang.includes('en')) || voices[0];
    }
}

function startVoiceConversation() {
    if (!recognition) {
        initializeVoiceChat();
        return;
    }
    
    isRecording = true;
    recognition.start();
    showNotification('üéôÔ∏è B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán b·∫±ng gi·ªçng n√≥i', 'success');
}

function stopVoiceConversation() {
    if (recognition && isRecording) {
        isRecording = false;
        recognition.stop();
        showNotification('‚èπÔ∏è ƒê√£ d·ª´ng cu·ªôc tr√≤ chuy·ªán', 'info');
    }
}

function handleVoiceInput(transcript) {
    updateVoiceStatus('ƒêang x·ª≠ l√Ω...', false);
    
    // Add user message to chat
    addMessage(transcript, 'user');
    
    // Process with AI
    setTimeout(async () => {
        try {
            const aiResponse = await generateAIResponse(transcript);
            addMessage(aiResponse, 'ai');
            
            // Auto-speak response if in voice mode and not muted
            if ((currentChatMode === 'voice-to-voice' || isAutoVoiceResponse()) && !isMuted) {
                speakText(aiResponse);
            }
        } catch (error) {
            const errorMsg = 'Xin l·ªói, t√¥i kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n l√∫c n√†y.';
            addMessage(errorMsg, 'ai');
            if (!isMuted) speakText(errorMsg);
        }
    }, 500);
}

function isAutoVoiceResponse() {
    // Auto voice response when user used voice input in text mode
    return currentChatMode === 'voice-to-text' && isRecording;
}

function speakText(text) {
    if (!synthesis || isMuted) return;
    
    // Stop any ongoing speech
    synthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = currentVoice;
    utterance.rate = speechRate;
    utterance.pitch = 1;
    utterance.volume = 1;
    
    utterance.onstart = () => {
        showNotification('üó£Ô∏è AI ƒëang tr·∫£ l·ªùi b·∫±ng gi·ªçng n√≥i...', 'info');
    };
    
    utterance.onend = () => {
        if (currentChatMode === 'voice-to-voice' && isRecording) {
            // Continue listening in voice-to-voice mode
            setTimeout(() => {
                updateVoiceStatus('Ti·∫øp t·ª•c n√≥i...', true);
            }, 1000);
        }
    };
    
    synthesis.speak(utterance);
}

function updateVoiceStatus(text, isActive) {
    const statusText = document.getElementById('voiceStatusText');
    const animation = document.getElementById('voiceAnimation');
    
    if (statusText) statusText.textContent = text;
    if (animation) {
        if (isActive) {
            animation.classList.add('active');
        } else {
            animation.classList.remove('active');
        }
    }
}

function changeAIVoice(value) {
    loadVoices();
    const voices = synthesis.getVoices();
    
    if (value.includes('female-vi')) {
        currentVoice = voices.find(voice => 
            voice.lang.includes('vi') && voice.name.toLowerCase().includes('female')
        ) || voices.find(voice => voice.lang.includes('vi'));
    } else if (value.includes('male-vi')) {
        currentVoice = voices.find(voice => 
            voice.lang.includes('vi') && voice.name.toLowerCase().includes('male')
        ) || voices.find(voice => voice.lang.includes('vi'));
    } else if (value.includes('female-en')) {
        currentVoice = voices.find(voice => 
            voice.lang.includes('en') && voice.name.toLowerCase().includes('female')
        ) || voices.find(voice => voice.lang.includes('en'));
    } else {
        currentVoice = voices.find(voice => 
            voice.lang.includes('en') && voice.name.toLowerCase().includes('male')
        ) || voices.find(voice => voice.lang.includes('en'));
    }
    
    showNotification(`üó£Ô∏è ƒê√£ ch·ªçn gi·ªçng ${value.replace('-', ' ').toUpperCase()}`, 'success');
}

function changeSpeechRate(rate) {
    speechRate = parseFloat(rate);
    document.getElementById('speechRateValue').textContent = rate + 'x';
}

function toggleMute() {
    isMuted = !isMuted;
    const muteBtn = document.getElementById('muteBtn');
    const muteText = document.getElementById('muteText');
    const icon = muteBtn.querySelector('i');
    
    if (isMuted) {
        icon.setAttribute('data-lucide', 'volume-x');
        muteText.textContent = 'B·∫≠t ti·∫øng';
        synthesis.cancel(); // Stop any current speech
        showNotification('üîá ƒê√£ t·∫Øt ti·∫øng AI', 'info');
    } else {
        icon.setAttribute('data-lucide', 'volume-2');
        muteText.textContent = 'T·∫Øt ti·∫øng';
        showNotification('üîä ƒê√£ b·∫≠t ti·∫øng AI', 'info');
    }
    
    lucide.createIcons();
}

// Voice input for text mode
function startVoiceInput() {
    if (!recognition) {
        initializeVoiceChat();
        return;
    }
    
    const voiceBtn = document.getElementById('voiceInputBtn');
    
    if (isRecording) {
        // Stop recording
        isRecording = false;
        recognition.stop();
        voiceBtn.classList.remove('recording');
        showNotification('‚èπÔ∏è ƒê√£ d·ª´ng ghi √¢m', 'info');
    } else {
        // Start recording
        isRecording = true;
        recognition.start();
        voiceBtn.classList.add('recording');
        showNotification('üéôÔ∏è ƒêang ghi √¢m... N√≥i c√¢u h·ªèi c·ªßa b·∫°n', 'info');
        
        // Auto stop after 10 seconds
        setTimeout(() => {
            if (isRecording) {
                isRecording = false;
                recognition.stop();
                voiceBtn.classList.remove('recording');
            }
        }, 10000);
    }
}

// Image handling functions
function triggerChatImageUpload() {
    document.getElementById('chatImageInput').click();
}

function triggerChatCameraCapture() {
    startChatCamera();
}

function triggerChatFileUpload() {
    document.getElementById('chatFileInput').click();
}

function handleChatImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('‚ùå Vui l√≤ng ch·ªçn file ·∫£nh!', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        currentImageData = e.target.result;
        showImagePreview(file.name, e.target.result);
        showNotification('‚úÖ ƒê√£ ch·ªçn ·∫£nh th√†nh c√¥ng!', 'success');
    };
    reader.readAsDataURL(file);
}

function handleChatFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Handle different file types
    if (file.type.startsWith('image/')) {
        handleChatImageUpload(event);
    } else {
        showNotification(`üìé File "${file.name}" ƒë√£ ƒë∆∞·ª£c ch·ªçn (${(file.size / 1024 / 1024).toFixed(1)}MB)`, 'info');
    }
}

async function startChatCamera() {
    try {
        chatCameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
        });
        
        const video = document.getElementById('chatCameraPreview');
        video.srcObject = chatCameraStream;
        video.style.display = 'block';
        
        // Auto capture after 3 seconds
        setTimeout(() => {
            captureChatPhoto();
        }, 3000);
        
        showNotification('üì∏ Camera ƒë√£ b·∫≠t, s·∫Ω t·ª± ƒë·ªông ch·ª•p sau 3 gi√¢y...', 'info');
    } catch (error) {
        console.error('Camera error:', error);
        showNotification('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera', 'error');
    }
}

function captureChatPhoto() {
    const video = document.getElementById('chatCameraPreview');
    const canvas = document.getElementById('chatCameraCanvas');
    
    if (!video.videoWidth) return;
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    currentImageData = canvas.toDataURL('image/jpeg', 0.8);
    showImagePreview('camera_capture.jpg', currentImageData);
    
    // Stop camera
    if (chatCameraStream) {
        chatCameraStream.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
    }
    
    showNotification('üì∏ ƒê√£ ch·ª•p ·∫£nh th√†nh c√¥ng!', 'success');
}

function showImagePreview(fileName, imageData) {
    const container = document.getElementById('imagePreviewContainer');
    const preview = document.getElementById('chatImagePreview');
    const fileNameSpan = document.getElementById('imageFileName');
    
    preview.src = imageData;
    fileNameSpan.textContent = fileName;
    container.style.display = 'block';
}

function removeChatImage() {
    currentImageData = null;
    document.getElementById('imagePreviewContainer').style.display = 'none';
    document.getElementById('chatImageInput').value = '';
    showNotification('üóëÔ∏è ƒê√£ x√≥a ·∫£nh', 'info');
}

// Enhanced message sending
function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message && !currentImageData) {
        showNotification('‚ùå Vui l√≤ng nh·∫≠p tin nh·∫Øn ho·∫∑c ch·ªçn ·∫£nh!', 'error');
        return;
    }
    
    // Clear input
    messageInput.value = '';
    
    // Add user message with image if available
    if (currentImageData) {
        addMessageWithImage(message || '·∫¢nh ƒë√≠nh k√®m', 'user', currentImageData);
        currentImageData = null;
        document.getElementById('imagePreviewContainer').style.display = 'none';
    } else {
        addMessage(message, 'user');
    }
    
    // Show typing indicator
    showTypingIndicator();
    
    // Get AI response
    setTimeout(async () => {
        try {
            let aiResponse;
            if (currentImageData) {
                // Handle image + text
                aiResponse = await generateImageResponse(message, currentImageData);
            } else {
                aiResponse = await generateAIResponse(message);
            }
            
            hideTypingIndicator();
            addMessage(aiResponse, 'ai');
            
            // Auto voice response if enabled
            if (isAutoVoiceResponse() && !isMuted) {
                speakText(aiResponse);
            }
        } catch (error) {
            hideTypingIndicator();
            addMessage('Xin l·ªói, c√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω c√¢u h·ªèi c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.', 'ai');
        }
    }, 1000);
}

function addMessageWithImage(text, sender, imageData) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender} with-image`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    if (imageData) {
        const img = document.createElement('img');
        img.src = imageData;
        img.className = 'message-image';
        img.onclick = () => openImageModal(imageData);
        content.appendChild(img);
    }
    
    if (text) {
        const textDiv = document.createElement('div');
        textDiv.textContent = text;
        content.appendChild(textDiv);
    }
    
    // Add voice controls for AI messages
    if (sender === 'ai' && text) {
        const voiceControls = document.createElement('div');
        voiceControls.className = 'voice-controls-message';
        voiceControls.innerHTML = `
            <button class="voice-control-btn" onclick="speakText('${text.replace(/'/g, '\\\'')}')" title="ƒê·ªçc to">
                <i data-lucide="volume-2"></i> ƒê·ªçc
            </button>
            <button class="voice-control-btn" onclick="copyToClipboard('${text.replace(/'/g, '\\\'')}')" title="Sao ch√©p">
                <i data-lucide="copy"></i> Copy
            </button>
        `;
        content.appendChild(voiceControls);
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Initialize icons
    lucide.createIcons();
}

function openImageModal(imageData) {
    // Create modal to show full image
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
    `;
    
    const img = document.createElement('img');
    img.src = imageData;
    img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
    
    modal.appendChild(img);
    modal.onclick = () => document.body.removeChild(modal);
    document.body.appendChild(modal);
}

async function generateImageResponse(text, imageData) {
    // Simulate AI analysis of image + text
    const imageAnalysis = [
        'T√¥i th·∫•y ƒë√¢y l√† m·ªôt t√†i li·ªáu ph√°p l√Ω. D·ª±a v√†o n·ªôi dung ·∫£nh, t√¥i c√≥ th·ªÉ gi√∫p b·∫°n ph√¢n t√≠ch c√°c ƒëi·ªÅu kho·∫£n quan tr·ªçng.',
        '·∫¢nh n√†y c√≥ v·∫ª l√† h·ª£p ƒë·ªìng ho·∫∑c vƒÉn b·∫£n ph√°p l√Ω. B·∫°n c√≥ th·ªÉ cho t√¥i bi·∫øt c·ª• th·ªÉ b·∫°n mu·ªën t√¥i gi·∫£i th√≠ch ph·∫ßn n√†o kh√¥ng?',
        'T·ª´ ·∫£nh b·∫°n g·ª≠i, t√¥i nh·∫≠n th·∫•y ƒë√¢y l√† t√†i li·ªáu li√™n quan ƒë·∫øn ph√°p lu·∫≠t. T√¥i s·∫Ω c·ªë g·∫Øng h·ªó tr·ª£ b·∫°n ph√¢n t√≠ch n·ªôi dung n√†y.',
        'D·ª±a v√†o ·∫£nh v√† c√¢u h·ªèi c·ªßa b·∫°n, t√¥i hi·ªÉu b·∫°n c·∫ßn h·ªó tr·ª£ v·ªÅ v·∫•n ƒë·ªÅ ph√°p l√Ω n√†y. H√£y cho t√¥i bi·∫øt th√™m chi ti·∫øt.'
    ];
    
    const response = imageAnalysis[Math.floor(Math.random() * imageAnalysis.length)];
    return text ? `${response}\n\nV·ªÅ c√¢u h·ªèi "${text}" c·ªßa b·∫°n: ${await generateAIResponse(text)}` : response;
}

// Update the initializeApp function
function initializeApp() {
    setupNavigation();
    setupMobileMenu();
    setupChatFeatures();
    setupDocumentFeatures();
    setupSearchFeatures();
    setupContractFeatures();
    setupVoiceFeatures();
    initializeLanguage();
    initializePWA();
    
    // Initialize voice features
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
    }
    
    // Show default endpoint in API docs
    showEndpoint('chat');
}

// Initialize tooltips (if needed)
function initializeTooltips() {
    const tooltipElements = document.querySelectorAll('[title]');
    
    tooltipElements.forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = this.title;
            tooltip.style.cssText = `
                position: absolute;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 0.5rem;
                border-radius: 4px;
                font-size: 0.8rem;
                z-index: 10000;
                pointer-events: none;
                white-space: nowrap;
            `;
            
            document.body.appendChild(tooltip);
            
            const rect = this.getBoundingClientRect();
            tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
            
            this.tooltip = tooltip;
            this.removeAttribute('title');
        });
        
        element.addEventListener('mouseleave', function() {
            if (this.tooltip) {
                document.body.removeChild(this.tooltip);
                this.title = this.tooltip.textContent;
                this.tooltip = null;
            }
        });
    });
}